<script type="text/javascript">
    RED.nodes.registerType('pti-flow-generator',  {
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            dashboardTabName: { value: "PTI Config" },
            dashboardGroupName: { value: "PTI Settings" },
            enableBasicFlow: { value: false },
            enableBarcodeEvent: { value: false },
            enableResultEvent: { value: false },
            enableBoardCodeReturn: { value: false },
            inputFields: { 
                value: JSON.stringify([ 
                    { name: "设备状态上传Url", key: "DevStatusUrl" },
                    { name: "拼版码查询Url", key: "copyUrl" }
                ]),
                validate: function(v) {
                    try {
                        return Array.isArray(JSON.parse(v)); 
                    } catch(e) {
                        return false;
                    }
                }
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "file.png", 
        label: function() {
            return this.name  || "PTI Flow Generator";
        },
        oneditprepare: function() {
            // Initialize fields from config 
            $("#node-input-name").val(this.name); 
            $("#node-input-dashboardTabName").val(this.dashboardTabName); 
            $("#node-input-dashboardGroupName").val(this.dashboardGroupName); 
            $("#node-input-enableBasicFlow").prop('checked', this.enableBasicFlow);
            $("#node-input-enableBarcodeEvent").prop('checked', this.enableBarcodeEvent);
            $("#node-input-enableResultEvent").prop('checked', this.enableResultEvent);
            $("#node-input-enableBoardCodeReturn").prop('checked', this.enableBoardCodeReturn);
            
            // 初始化时根据基础流程勾选状态显示/隐藏子选项
            toggleSubOptions();
            
            // 为基础流程勾选框添加事件监听器
            $("#node-input-enableBasicFlow").change(function() {
                toggleSubOptions();
            });
            
            // 为条码事件勾选框添加事件监听器
            $("#node-input-enableBarcodeEvent").change(function() {
                toggleBarcodeSubOptions();
            });
            
            function toggleSubOptions() {
                if ($("#node-input-enableBasicFlow").prop('checked')) {
                    $("#sub-options").show();
                    toggleBarcodeSubOptions(); // 同时检查条码事件的子选项
                } else {
                    $("#sub-options").hide();
                    $("#barcode-sub-options").hide();
                    $("#node-input-enableBarcodeEvent").prop('checked', false);
                    $("#node-input-enableResultEvent").prop('checked', false);
                    $("#node-input-enableBoardCodeReturn").prop('checked', false);
                }
            }
            
            function toggleBarcodeSubOptions() {
                if ($("#node-input-enableBasicFlow").prop('checked') && $("#node-input-enableBarcodeEvent").prop('checked')) {
                    $("#barcode-sub-options").show();
                } else {
                    $("#barcode-sub-options").hide();
                    $("#node-input-enableBoardCodeReturn").prop('checked', false);
                }
            }
            
            // Initialize the editable list
            var container = $('#node-input-inputFields-container');
            container.empty(); 
            
            var list = $('<div>', {
                id: 'node-input-inputFields-list',
                style: 'min-height: 100px; margin-bottom: 10px;'
            }).appendTo(container);
            
            // Parse and load existing fields 
            var fields = [];
            try {
                fields = JSON.parse(this.inputFields); 
            } catch(e) {
                fields = [
                    { name: "设备状态上传Url", key: "DevStatusUrl" },
                    { name: "拼版码查询Url", key: "copyUrl" }
                ];
            }
            
            // Add existing items 
            fields.forEach(function(field)  {
                addFieldRow(list, field);
            });
            
            // Add button 
            $('<button>', {
                id: 'btn-add-field',
                class: 'red-ui-button',
                style: 'width: auto; margin-bottom: 10px;',
                html: '<i class="fa fa-plus"></i> 添加字段'
            }).click(function() {
                addFieldRow(list);
            }).appendTo(container);
        },
        oneditsave: function() {
            // Collect all input fields before saving
            var fields = [];
            $('#node-input-inputFields-list .input-field-row').each(function() {
                var name = $(this).find('.input-field-name').val();
                var key = $(this).find('.input-field-key').val();
                if (name && key) {
                    fields.push({name:  name, key: key});
                }
            });
            
            // Save all config values 
            this.name  = $("#node-input-name").val();
            this.dashboardTabName  = $("#node-input-dashboardTabName").val();
            this.dashboardGroupName  = $("#node-input-dashboardGroupName").val();
            this.enableBasicFlow = $("#node-input-enableBasicFlow").prop('checked');
            this.enableBarcodeEvent = $("#node-input-enableBarcodeEvent").prop('checked');
            this.enableResultEvent = $("#node-input-enableResultEvent").prop('checked');
            this.enableBoardCodeReturn = $("#node-input-enableBoardCodeReturn").prop('checked');
            this.inputFields  = JSON.stringify(fields.length  > 0 ? fields : [
                { name: "设备状态上传Url", key: "DevStatusUrl" },
                { name: "拼版码查询Url", key: "copyUrl" }
            ]);
        }
    });
    
    function addFieldRow(container, data) {
        var row = $('<div>', {
            class: 'input-field-row',
            style: 'display: flex; margin-bottom: 5px; align-items: center;'
        }).appendTo(container);
        
        $('<input>', {
            type: 'text',
            class: 'input-field-name red-ui-text-input',
            style: 'flex: 1; margin-right: 5px; min-width: 150px;',
            placeholder: '字段名称'
        }).val(data ? data.name  : '').appendTo(row);
        
        $('<input>', {
            type: 'text',
            class: 'input-field-key red-ui-text-input',
            style: 'flex: 1; margin-right: 5px; min-width: 150px;',
            placeholder: '字段键名'
        }).val(data ? data.key  : '').appendTo(row);
        
        $('<button>', {
            class: 'red-ui-button red-ui-button-small',
            html: '<i class="fa fa-trash"></i>',
            click: function() {
                row.remove(); 
            }
        }).appendTo(row);
    }
</script>
 
<script type="text/x-red" data-template-name="pti-flow-generator">
    <!-- UI设计配置 -->
    <div class="form-row">
        <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: bold;">UI设计</h3>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 节点名称</label>
        <input type="text" id="node-input-name" placeholder="名称">
    </div>
    <div class="form-row">
        <label for="node-input-dashboardTabName"><i class="fa fa-list"></i> Dashboard标签名称</label>
        <input type="text" id="node-input-dashboardTabName" placeholder="PTI Config">
    </div>
    <div class="form-row">
        <label for="node-input-dashboardGroupName"><i class="fa fa-object-group"></i> Dashboard分组名称</label>
        <input type="text" id="node-input-dashboardGroupName" placeholder="PTI Settings">
    </div>
    <div class="form-row">
        <label><i class="fa fa-list-ol"></i> 输入字段配置</label>
        <div id="node-input-inputFields-container"></div>
    </div>
    
    <!-- 分割线 -->
    <div class="form-row">
        <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
    </div>
    
    <!-- 基础流程配置 -->
    <div class="form-row">
        <h3 style="margin: 0 0 10px 0; color: #666; font-size: 14px; font-weight: bold;">基础流程</h3>
    </div>
    <div class="form-row">
        <div style="margin-left: 0px;">
            <label for="node-input-enableBasicFlow" style="width: auto; font-weight: normal; display: inline-flex; align-items: center; margin: 0;">
                <input type="checkbox" id="node-input-enableBasicFlow" style="margin: 0 5px 0 0; width: auto; height: auto;">
                接收处理
            </label>
            <div id="sub-options" style="margin-left: 20px; margin-top: 10px; display: none;">
                <div style="margin-bottom: 5px;">
                    <label for="node-input-enableBarcodeEvent" style="width: auto; font-weight: normal; display: inline-flex; align-items: center; margin: 0;">
                        <input type="checkbox" id="node-input-enableBarcodeEvent" style="margin: 0 5px 0 0; width: auto; height: auto;">
                        条码事件
                    </label>
                    <div id="barcode-sub-options" style="margin-left: 20px; margin-top: 5px; display: none;">
                        <label for="node-input-enableBoardCodeReturn" style="width: auto; font-weight: normal; display: inline-flex; align-items: center; margin: 0; font-size: 14px;">
                            <input type="checkbox" id="node-input-enableBoardCodeReturn" style="margin: 0 5px 0 0; width: auto; height: auto;">
                            是否返回联板条码
                        </label>
                    </div>
                </div>
                <div>
                    <label for="node-input-enableResultEvent" style="width: auto; font-weight: normal; display: inline-flex; align-items: center; margin: 0;">
                        <input type="checkbox" id="node-input-enableResultEvent" style="margin: 0 5px 0 0; width: auto; height: auto;">
                        结果事件
                    </label>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="pti-flow-generator">
    <p>PTI测试环境管理器 - 用于动态生成完整的PTI（Production Test Interface）测试流程的Node-RED节点。</p>
    
    <h3>功能概述</h3>
    <p>该节点可以根据配置自动生成包含以下功能的完整Node-RED流程：</p>
    <ul>
        <li>Dashboard用户界面配置</li>
        <li>动态输入字段管理</li>
        <li>数据存储和读取功能</li>
        <li>可选的测试事件处理流程</li>
    </ul>

    <h3>UI设计配置</h3>
    <dl class="message-properties">
        <dt>节点名称</dt>
        <dd>自定义节点的显示名称</dd>
        
        <dt>Dashboard标签名称</dt>
        <dd>生成的Dashboard标签页名称，默认为"PTI Config"</dd>
        
        <dt>Dashboard分组名称</dt>
        <dd>Dashboard中的分组名称，默认为"PTI Settings"</dd>
        
        <dt>输入字段配置</dt>
        <dd>可动态添加/删除的输入字段，每个字段包含显示名称和键名</dd>
    </dl>

    <h3>基础流程配置</h3>
    <dl class="message-properties">
        <dt>接收处理</dt>
        <dd>启用基础的测试事件接收和处理流程</dd>
        
        <dt class="optional">条码事件</dt>
        <dd>启用条码扫描和进站处理功能，包括HTTP请求、状态检查等</dd>
        
        <dt class="optional">是否返回联板条码</dt>
        <dd>当启用条码事件时，可选择是否生成联板条码处理逻辑</dd>
        
        <dt class="optional">结果事件</dt>
        <dd>启用测试结果处理和出站功能，包括循环处理、数据汇总等</dd>
    </dl>

    <h3>生成的流程包含</h3>
    <h4>基础功能</h4>
    <ul>
        <li>Dashboard UI界面（输入字段、保存按钮、显示区域）</li>
        <li>数据汇总和文件存储功能</li>
        <li>配置文件读取和解析</li>
        <li>参数设置和存储功能</li>
    </ul>

    <h4>条码事件流程（可选）</h4>
    <ul>
        <li>条码扫描调试和数据获取</li>
        <li>进站模板和HTTP请求处理</li>
        <li>服务器响应超时检测</li>
        <li>联板/单板条码处理逻辑</li>
        <li>状态检查和错误处理</li>
    </ul>

    <h4>结果事件流程（可选）</h4>
    <ul>
        <li>测试结果接收和处理</li>
        <li>出站事件调用和数据存储</li>
        <li>循环控制和批量处理</li>
        <li>过站数据上传和响应处理</li>
        <li>结果汇总和状态判断</li>
    </ul>

    <h3>输入</h3>
    <p>接收任意消息触发流程生成。</p>

    <h3>输出</h3>
    <p><code>msg.payload</code> 包含生成的完整Node-RED流程配置（JSON数组格式）。</p>

    <h3>使用说明</h3>
    <ol>
        <li>配置Dashboard相关信息</li>
        <li>添加需要的输入字段</li>
        <li>根据需要启用基础流程功能</li>
        <li>发送消息触发节点生成流程</li>
        <li>将输出的流程配置导入到Node-RED中</li>
    </ol>

    <h3>注意事项</h3>
    <ul>
        <li>生成的流程包含大量节点，建议在独立的流程标签页中使用</li>
        <li>条码事件和结果事件功能需要相应的外部服务支持</li>
        <li>文件存储路径默认为D:\PTI-MES\json\，请确保目录存在</li>
        <li>所有配置会自动保存到全局变量中</li>
    </ul>
</script>
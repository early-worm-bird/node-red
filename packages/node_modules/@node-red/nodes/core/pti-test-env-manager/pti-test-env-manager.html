<script type="text/javascript">
    RED.nodes.registerType('pti-flow-generator',  {
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            dashboardTabName: { value: "PTI Config" },
            dashboardGroupName: { value: "PTI Settings" },
            inputFields: { 
                value: JSON.stringify([ 
                    { name: "设备状态上传Url", key: "DevStatusUrl" },
                    { name: "拼版码查询Url", key: "copyUrl" }
                ]),
                validate: function(v) {
                    try {
                        return Array.isArray(JSON.parse(v)); 
                    } catch(e) {
                        return false;
                    }
                }
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "file.png", 
        label: function() {
            return this.name  || "PTI Flow Generator";
        },
        oneditprepare: function() {
            // Initialize fields from config 
            $("#node-input-name").val(this.name); 
            $("#node-input-dashboardTabName").val(this.dashboardTabName); 
            $("#node-input-dashboardGroupName").val(this.dashboardGroupName); 
            
            // Initialize the editable list
            var container = $('#node-input-inputFields-container');
            container.empty(); 
            
            var list = $('<div>', {
                id: 'node-input-inputFields-list',
                style: 'min-height: 100px; margin-bottom: 10px;'
            }).appendTo(container);
            
            // Parse and load existing fields 
            var fields = [];
            try {
                fields = JSON.parse(this.inputFields); 
            } catch(e) {
                fields = [
                    { name: "设备状态上传Url", key: "DevStatusUrl" },
                    { name: "拼版码查询Url", key: "copyUrl" }
                ];
            }
            
            // Add existing items 
            fields.forEach(function(field)  {
                addFieldRow(list, field);
            });
            
            // Add button 
            $('<button>', {
                id: 'btn-add-field',
                class: 'red-ui-button',
                style: 'width: auto; margin-bottom: 10px;',
                html: '<i class="fa fa-plus"></i> 添加字段'
            }).click(function() {
                addFieldRow(list);
            }).appendTo(container);
        },
        oneditsave: function() {
            // Collect all input fields before saving
            var fields = [];
            $('#node-input-inputFields-list .input-field-row').each(function() {
                var name = $(this).find('.input-field-name').val();
                var key = $(this).find('.input-field-key').val();
                if (name && key) {
                    fields.push({name:  name, key: key});
                }
            });
            
            // Save all config values 
            this.name  = $("#node-input-name").val();
            this.dashboardTabName  = $("#node-input-dashboardTabName").val();
            this.dashboardGroupName  = $("#node-input-dashboardGroupName").val();
            this.inputFields  = JSON.stringify(fields.length  > 0 ? fields : [
                { name: "设备状态上传Url", key: "DevStatusUrl" },
                { name: "拼版码查询Url", key: "copyUrl" }
            ]);
        }
    });
    
    function addFieldRow(container, data) {
        var row = $('<div>', {
            class: 'input-field-row',
            style: 'display: flex; margin-bottom: 5px; align-items: center;'
        }).appendTo(container);
        
        $('<input>', {
            type: 'text',
            class: 'input-field-name red-ui-text-input',
            style: 'flex: 1; margin-right: 5px; min-width: 150px;',
            placeholder: '字段名称'
        }).val(data ? data.name  : '').appendTo(row);
        
        $('<input>', {
            type: 'text',
            class: 'input-field-key red-ui-text-input',
            style: 'flex: 1; margin-right: 5px; min-width: 150px;',
            placeholder: '字段键名'
        }).val(data ? data.key  : '').appendTo(row);
        
        $('<button>', {
            class: 'red-ui-button red-ui-button-small',
            html: '<i class="fa fa-trash"></i>',
            click: function() {
                row.remove(); 
            }
        }).appendTo(row);
    }
</script>
 
<script type="text/x-red" data-template-name="pti-flow-generator">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 节点名称</label>
        <input type="text" id="node-input-name" placeholder="名称">
    </div>
    <div class="form-row">
        <label for="node-input-dashboardTabName"><i class="fa fa-list"></i> Dashboard标签名称</label>
        <input type="text" id="node-input-dashboardTabName" placeholder="PTI Config">
    </div>
    <div class="form-row">
        <label for="node-input-dashboardGroupName"><i class="fa fa-object-group"></i> Dashboard分组名称</label>
        <input type="text" id="node-input-dashboardGroupName" placeholder="PTI Settings">
    </div>
    <div class="form-row">
        <label><i class="fa fa-list-ol"></i> 输入字段配置</label>
        <div id="node-input-inputFields-container"></div>
    </div>
</script>
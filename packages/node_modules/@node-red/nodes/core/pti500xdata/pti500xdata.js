module.exports = function (RED) {
    function pti500xdataNode(config) {
        RED.nodes.createNode(this, config);
        var node = this;
        node.on("input", function (msg) {

            const data = msg.payload.data
            const time = msg.payload.time
            let testResult = 'Passed'
            let unTestCount = 0
            let testCount = 0
            let totalCount = 0
            let failCount = 0
            let passRate = 0
            let passCount = 0
            let bomVersion = ''

            for (let subData of data) {
                totalCount += subData.length
                for (let items of subData) {
                    if (items.result) {
                        testCount += 1
                        if (items.result.includes('FAIL')) {
                            testResult = 'Failed'
                            failCount += 1
                        }
                        else if (items.result.includes('PASS')) {
                            passCount += 1
                        }
                    }
                    else unTestCount += 1
                }
            }

            passRate = (1 - (failCount / testCount)) * 100
            passRate = passRate.toString() + '%'

            bomVersion = msg.payload.bomName
            const parts = bomVersion.split("\\");
            const lastPart = parts[parts.length - 1];

            msg.payload.bomName = lastPart
            msg.payload.passCount = passCount
            msg.payload.passRate = passRate
            msg.payload.testResult = testResult
            msg.payload.unTestCount = unTestCount
            msg.payload.testCount = testCount
            msg.payload.totalCount = totalCount
            msg.payload.failCount = failCount
            var msg1 = { payload: msg.payload.bomName };//BOM文件路径名
            var msg2 = { payload: msg.payload.passCount };//通过次数
            var msg3 = { payload: msg.payload.passRate };//通过率
            var msg4 = { payload: msg.payload.testResult };//测试结果
            var msg5 = { payload: msg.payload.unTestCount };//没有测试的数量
            var msg6 = { payload: msg.payload.testCount };//测试数量
            var msg7 = { payload: msg.payload.totalCount };//总次数
            var msg8 = { payload: msg.payload.failCount };//失败次数
            var msg9 = { payload: msg.payload.name };//测试工程名
            var msg10 = { payload: msg.payload.time };//测试起止时间
            var msg11 = { payload: msg.payload.custom };//自定义表单
            var msg12 = { payload: msg.payload.layer};//自定义表单
            this.send([ msg1,msg2,msg3,msg4,msg5,msg6,msg7,msg8,msg9,msg10,msg11,msg12,msg]);
            
        });
    }
    RED.nodes.registerType("pti500xdata", pti500xdataNode);
}
//npm install E:\lsd学习文件\Node-Red\node-red\packages\node_modules\@node-red\nodes\core\mynode
